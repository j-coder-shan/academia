<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecturer Dashboard - Academia LMS</title>
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="../../css/dashboard.css">
    <link rel="icon" type="image/x-icon" href="../../assets/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    /* Enhanced User Info Styling */
.user-info {
    padding: 20px;
    text-align: center;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    margin-bottom: 20px;
}

.user-name {
    font-weight: 600;
    font-size: 1.1rem;
    color: white;
    margin: 10px 0 5px 0;
    text-transform: capitalize;
}

.user-role {
    color: rgba(255,255,255,0.8);
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: 500;
}

.user-avatar {
    width: 60px;
    height: 60px;
    background: rgba(255,255,255,0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 10px;
    font-size: 1.5rem;
    color: white;
}
</style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <i class="fas fa-graduation-cap"></i>
                    <h1>Academia LMS</h1>
                </div>
            </div>
            
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">
                    <i class="fas fa-chalkboard-teacher"></i>
                </div>
                <div class="user-name" id="userName">Loading...</div>
                <div class="user-role">Lecturer</div>
            </div>
            
            <nav class="nav-menu">
                <div class="nav-item">
                    <a href="dashboard.html" class="nav-link active">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="courses.html" class="nav-link">
                        <i class="fas fa-book-open"></i>
                        <span>Courses</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="manage-courses.html" class="nav-link">
                        <i class="fas fa-cogs"></i>
                        <span>Manage Courses</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="presentations.html" class="nav-link">
                        <i class="fas fa-tv"></i>
                        <span>Presentations</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="assignments.html" class="nav-link">
                        <i class="fas fa-tasks"></i>
                        <span>Assignments</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="evaluation.html" class="nav-link">
                        <i class="fas fa-clipboard-check"></i>
                        <span>Evaluations</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="calendar.html" class="nav-link">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Calendar</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="profile.html" class="nav-link">
                        <i class="fas fa-user"></i>
                        <span>Profile</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="settings.html" class="nav-link">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <h2 class="header-title">Lecturer Dashboard</h2>
                </div>
                <div class="header-actions">
                    <button class="header-btn" title="Notifications">
                        <i class="fas fa-bell"></i>
                    </button>
                    <button class="header-btn" id="logoutBtn" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </header>

            <!-- Content -->
            <div class="content">
                <!-- Dashboard Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">Active Courses</div>
                            <div class="stat-card-icon enrolled">
                                <i class="fas fa-book-open"></i>
                            </div>
                        </div>
                        <div class="stat-card-value" id="activeCourses">0</div>
                        <div class="stat-card-label">Courses teaching</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">Total Students</div>
                            <div class="stat-card-icon pending">
                                <i class="fas fa-user-graduate"></i>
                            </div>
                        </div>
                        <div class="stat-card-value" id="totalStudents">0</div>
                        <div class="stat-card-label">Enrolled students</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">Pending Grading</div>
                            <div class="stat-card-icon completed">
                                <i class="fas fa-clipboard-check"></i>
                            </div>
                        </div>
                        <div class="stat-card-value" id="pendingGrading">0</div>
                        <div class="stat-card-label">Assignments to grade</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">Presentations</div>
                            <div class="stat-card-icon grade">
                                <i class="fas fa-presentation"></i>
                            </div>
                        </div>
                        <div class="stat-card-value" id="totalPresentations">0</div>
                        <div class="stat-card-label">Created presentations</div>
                    </div>
                </div>

                <!-- Quick Actions Section -->
                <div class="section">
                    <div class="section-header">
                        <h3 class="section-title">Quick Actions</h3>
                    </div>
                    <div class="content-card">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding: 20px;">
                            <button class="btn btn-primary" onclick="createNewCourse()">
                                <i class="fas fa-plus"></i>
                                Create Course
                            </button>
                            <button class="btn btn-primary" onclick="createAssignment()">
                                <i class="fas fa-tasks"></i>
                                New Assignment
                            </button>
                            <button class="btn btn-primary" onclick="createPresentation()">
                                <i class="fas fa-presentation"></i>
                                New Presentation
                            </button>
                            <button class="btn btn-primary" onclick="gradeAssignments()">
                                <i class="fas fa-clipboard-check"></i>
                                Grade Assignments
                            </button>
                        </div>
                    </div>
                </div>

                <!-- My Courses Section -->
                <div class="section">
                    <div class="section-header">
                        <h3 class="section-title">My Courses</h3>
                        <a href="courses.html" class="btn btn-primary" style="width: 20%;">
                            <i class="fas fa-eye"></i>
                            View All
                        </a>
                    </div>
                    <div class="content-card">
                        <div id="myCourses" class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- Recent Submissions Section -->
                <div class="section">
                    <div class="section-header">
                        <h3 class="section-title">Recent Submissions</h3>
                        <a href="assignments.html" class="btn btn-primary" style="width: 20%;">
                            <i class="fas fa-eye"></i>
                            View All
                        </a>
                    </div>
                    <div class="content-card">
                        <div id="recentSubmissions" class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- Today's Schedule Section -->
                <div class="section">
                    <div class="section-header">
                        <h3 class="section-title">Today's Schedule</h3>
                        <a href="calendar.html" class="btn btn-primary" style="width: 20%;">
                            <i class="fas fa-calendar"></i>
                            Full Calendar
                        </a>
                    </div>
                    <div class="section-content">
                        <div id="todaySchedule" class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="../../js/auth.js"></script>
    <script src="../../js/lecturer-navigation.js"></script>
    <script src="../../js/lecturer-dashboard.js"></script>
    <script>
        // Enhanced user info update function
function updateUserInfo() {
    try {
        const userStr = localStorage.getItem('user');
        console.log('👤 Raw user data from localStorage:', userStr);
        
        if (userStr) {
            const user = JSON.parse(userStr);
            console.log('📊 Parsed user data:', user);
            
            const userNameEl = document.getElementById('userName');
            const userRoleEl = document.getElementById('userRole');
            const userAvatarEl = document.getElementById('userAvatar');
            
            // Update user name with multiple fallbacks
            const userName = user.name || user.username || user.fullName || user.displayName || 'User';
            if (userNameEl) {
                userNameEl.textContent = userName;
                console.log('✅ Updated userName to:', userName);
            }
            
            // Update user role with proper formatting
            const userRole = user.role || 'user';
            if (userRoleEl) {
                userRoleEl.textContent = userRole.toUpperCase();
                console.log('✅ Updated userRole to:', userRole.toUpperCase());
            }
            
            // Update avatar icon based on role
            if (userAvatarEl) {
                const avatarIcon = userAvatarEl.querySelector('i');
                if (avatarIcon) {
                    if (userRole === 'lecturer') {
                        avatarIcon.className = 'fas fa-chalkboard-teacher';
                    } else if (userRole === 'student') {
                        avatarIcon.className = 'fas fa-user-graduate';
                    } else {
                        avatarIcon.className = 'fas fa-user';
                    }
                    console.log('✅ Updated avatar icon for role:', userRole);
                }
            }
            
            // Log all available user properties for debugging
            console.log('🔍 Available user properties:', Object.keys(user));
            console.log('🔍 User object details:', {
                name: user.name,
                username: user.username,
                fullName: user.fullName,
                displayName: user.displayName,
                role: user.role,
                id: user.id || user._id,
                email: user.email
            });
            
        } else {
            console.log('❌ No user data found in localStorage');
            
            // Set default values
            const userNameEl = document.getElementById('userName');
            const userRoleEl = document.getElementById('userRole');
            
            if (userNameEl) userNameEl.textContent = 'Unknown User';
            if (userRoleEl) userRoleEl.textContent = 'USER';
        }
    } catch (error) {
        console.error('💥 Error updating user info:', error);
        
        // Set error state
        const userNameEl = document.getElementById('userName');
        const userRoleEl = document.getElementById('userRole');
        
        if (userNameEl) userNameEl.textContent = 'Error Loading';
        if (userRoleEl) userRoleEl.textContent = 'USER';
    }
}

// Enhanced function to fetch and update user profile
async function fetchAndUpdateUserProfile() {
    try {
        const token = localStorage.getItem('token');
        if (!token) {
            console.log('❌ No token available for profile fetch');
            return;
        }

        console.log('🔄 Fetching fresh user profile...');
        
        const response = await fetch('/api/auth/profile', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            if (data.success && data.user) {
                console.log('✅ Fresh user profile fetched:', data.user);
                
                // Update localStorage with fresh data
                localStorage.setItem('user', JSON.stringify(data.user));
                
                // Update UI
                updateUserInfo();
            }
        } else {
            console.log('⚠️ Profile fetch failed, using cached data');
            updateUserInfo();
        }
    } catch (error) {
        console.error('💥 Error fetching profile:', error);
        updateUserInfo(); // Fallback to cached data
    }
}

// Quick action functions
function createNewCourse() {
    window.location.href = 'courses.html?action=create';
}

        function createAssignment() {
            window.location.href = 'assignments.html?action=create';
        }

        function createPresentation() {
            window.location.href = 'presentations.html?action=create';
        }

        function gradeAssignments() {
            window.location.href = 'assignments.html?tab=grading';
        }

        // Add these functions to your lecturer dashboard.html script section

// Function to load lecturer dashboard data
async function loadLecturerDashboardData() {
    try {
        const token = localStorage.getItem('token');
        if (!token) {
            console.log('❌ No token found');
            return;
        }

        console.log('📊 Loading lecturer dashboard data...');

        // Fetch lecturer courses
        const coursesResponse = await fetch('/api/lecturer/courses', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        });

        if (coursesResponse.ok) {
            const coursesData = await coursesResponse.json();
            console.log('📚 Courses data:', coursesData);
            
            if (coursesData.success && coursesData.courses) {
                updateDashboardStats(coursesData.courses);
                displayMyCourses(coursesData.courses);
            }
        } else {
            console.error('❌ Failed to fetch courses:', coursesResponse.status);
        }

    } catch (error) {
        console.error('💥 Error loading dashboard data:', error);
    }
}

// Function to update dashboard statistics
function updateDashboardStats(courses) {
    try {
        console.log('📈 Updating dashboard stats with courses:', courses);

        // Calculate active courses
        const activeCourses = courses.filter(course => 
            course.status === 'active' || course.status === 'published' || !course.status
        );

        // Calculate total students
        const totalStudents = courses.reduce((total, course) => {
            return total + (course.enrolledCount || course.students?.length || 0);
        }, 0);

        // Update DOM elements
        const activeCoursesEl = document.getElementById('activeCourses');
        const totalStudentsEl = document.getElementById('totalStudents');

        if (activeCoursesEl) {
            activeCoursesEl.textContent = activeCourses.length;
            console.log('✅ Updated active courses count:', activeCourses.length);
        }

        if (totalStudentsEl) {
            totalStudentsEl.textContent = totalStudents;
            console.log('✅ Updated total students count:', totalStudents);
        }
        
    } catch (error) {
        console.error('💥 Error updating dashboard stats:', error);
    }
}

// Function to display courses
function displayMyCourses(courses) {
    const myCoursesEl = document.getElementById('myCourses');
    
    if (!myCoursesEl) return;

    if (courses.length === 0) {
        myCoursesEl.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #666;">
                <i class="fas fa-book-open" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                <h3>No Courses Created</h3>
                <p>Start by creating your first course.</p>
            </div>
        `;
        return;
    }

    const recentCourses = courses.slice(0, 3);

    myCoursesEl.innerHTML = `
        <div style="display: grid; gap: 15px;">
            ${recentCourses.map(course => `
                <div class="course-item" style="display: flex; align-items: center; padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; background: #f9f9f9;">
                    <div class="course-icon" style="width: 40px; height: 40px; background: #3f51b5; border-radius: 6px; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                        <i class="fas fa-book" style="color: white;"></i>
                    </div>
                    <div class="course-info" style="flex: 1;">
                        <h4 style="margin: 0 0 5px 0; font-size: 1rem; font-weight: 600;">${course.title || course.name || 'Untitled Course'}</h4>
                        <p style="margin: 0; font-size: 0.85rem; color: #666;">${course.code || 'No Code'} • ${course.enrolledCount || 0} students</p>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

// Enhanced DOMContentLoaded event
document.addEventListener('DOMContentLoaded', async function() {
    console.log('📄 DOM loaded, initializing lecturer dashboard...');

    // Update user info
    updateUserInfo();
    await fetchAndUpdateUserProfile();

    // Setup logout
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', function() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '../../login.html';
        });
    }

    // Load dashboard data
    await loadLecturerDashboardData();

    console.log('✅ Lecturer dashboard initialized');
});
    </script>
</body>
</html>

